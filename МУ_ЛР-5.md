# –ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç–µ ‚Ññ5

**–û—Ü–µ–Ω–∫–∞ –º–æ–¥–µ–ª–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Model Registry (–ø—Ä–æ–µ–∫—Ç [mlops-flight-delay](https://github.com/Irina-64/mlops-flight-delay))**

***

## üéØ –¶–µ–ª—å

–ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é **–æ—Ü–µ–Ω–∫—É –æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏**, –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏,
–∞ —Ç–∞–∫–∂–µ **–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Ä—Å–∏—é –º–æ–¥–µ–ª–∏ –≤ MLflow Model Registry**, –ø—Ä–∏—Å–≤–æ–∏–≤ –µ–π stage (`Staging` / `Production`).

***

## ‚öôÔ∏è –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ä–µ–¥—ã

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞:

```bash
git clone https://github.com/Irina-64/mlops-flight-delay.git
cd mlops-flight-delay
```

2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```bash
pip install -r requirements.txt
pip install mlflow matplotlib seaborn scikit-learn
```

3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–¥–µ–ª—å —É–∂–µ –æ–±—É—á–µ–Ω–∞ –∏ –µ—Å—Ç—å —Ñ–∞–π–ª `models/model.pkl`
–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
python src/preprocess.py
python src/train.py
```

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

```
data/split/X_test.csv
data/split/y_test.csv
```

–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏—Ö (—Å–º. –õ–†3).

***

## üß© –®–∞–≥ 1 ‚Äî –°–æ–∑–¥–∞–Ω–∏–µ `src/evaluate.py`

–û—Ü–µ–Ω–∫–∞ –º–æ–¥–µ–ª–∏ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –°–∫—Ä–∏–ø—Ç –≤–∫–ª—é—á–∞–µ—Ç:

### –ü—Ä–∏–º–µ—Ä `src/evaluate.py`

```python
import mlflow
import mlflow.sklearn
import pandas as pd
import joblib
import json
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.metrics import (
    accuracy_score, f1_score, precision_score, recall_score, roc_auc_score,
    confusion_matrix, classification_report
)

OUTPUT_JSON = "reports/eval.json"
OUTPUT_HTML = "reports/eval.html"

def evaluate(model_path, X_path, y_path):
    # –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –∏ –¥–∞–Ω–Ω—ã—Ö
    model = joblib.load(model_path)
    X_test = pd.read_csv(X_path)
    y_test = pd.read_csv(y_path).values.ravel()

    # –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
    y_pred = model.predict(X_test)
    y_proba = model.predict_proba(X_test)[:, 1]

    # –º–µ—Ç—Ä–∏–∫–∏
    metrics = {
        "accuracy": accuracy_score(y_test, y_pred),
        "precision": precision_score(y_test, y_pred),
        "recall": recall_score(y_test, y_pred),
        "f1": f1_score(y_test, y_pred),
        "roc_auc": roc_auc_score(y_test, y_proba)
    }

    # confusion matrix
    cm = confusion_matrix(y_test, y_pred)
    plt.figure(figsize=(5,4))
    sns.heatmap(cm, annot=True, fmt='d', cmap='Blues')
    plt.title("Confusion Matrix")
    plt.xlabel("Predicted")
    plt.ylabel("True")
    plt.tight_layout()
    plt.savefig("reports/confusion_matrix.png")

    # —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ JSON
    with open(OUTPUT_JSON, "w") as f:
        json.dump(metrics, f, indent=4)
    print(f"Metrics saved in {OUTPUT_JSON}")

    # HTML –æ—Ç—á—ë—Ç
    with open(OUTPUT_HTML, "w") as f:
        f.write("<h2>Model Evaluation Report</h2>")
        f.write("<ul>" + "".join([f"<li>{k}: {v:.4f}</li>" for k, v in metrics.items()]) + "</ul>")
        f.write('<img src="confusion_matrix.png" alt="Confusion Matrix">')

    return metrics

if __name__ == "__main__":
    mlflow.set_experiment("flight_delay_evaluation")
    with mlflow.start_run(run_name="evaluate_model"):
        metrics = evaluate(
            model_path="models/model.pkl",
            X_path="data/split/X_test.csv",
            y_path="data/split/y_test.csv"
        )
        # –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        mlflow.log_metrics(metrics)
        mlflow.log_artifact("reports/confusion_matrix.png")
        mlflow.log_artifact("reports/eval.json")
        mlflow.log_artifact("reports/eval.html")

        mlflow.sklearn.log_model(joblib.load("models/model.pkl"), "model")
        print("Evaluation complete and results logged to MLflow.")
```


***

## üß≠ –®–∞–≥ 2 ‚Äî –ó–∞–ø—É—Å–∫ –æ—Ü–µ–Ω–∫–∏

```bash
python src/evaluate.py
```

‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–≤–æ–¥:

```
Metrics saved in reports/eval.json
Evaluation complete and results logged to MLflow.
```

üëâ –í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `reports/` –ø–æ—è–≤—è—Ç—Å—è —Ñ–∞–π–ª—ã:

```
eval.json
eval.html
confusion_matrix.png
```


***

## üß∞ –®–∞–≥ 3 ‚Äî –û—Ç–∫—Ä—ã—Ç—å MLflow UI

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å MLflow –ª–æ–∫–∞–ª—å–Ω–æ:

```bash
mlflow ui --host 0.0.0.0 --port 5000
```

2. –ü–µ—Ä–µ–π—Ç–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:5000
3. –ù–∞–π—Ç–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç `flight_delay_evaluation`.

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:

- Run —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º *Finished*
- –ú–µ—Ç—Ä–∏–∫–∏ (accuracy, f1, roc_auc –∏ —Ç.–ø.)
- –í–∫–ª–∞–¥–∫–∞ **Artifacts** —Å–æ–¥–µ—Ä–∂–∏—Ç `eval.json` –∏ `model`

***

## üè∑Ô∏è –®–∞–≥ 4 ‚Äî –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ –≤ **Model Registry**

1. –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ **MLflow UI**:
    - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –Ω—É–∂–Ω–æ–º—É **Run** —Å –ª—É—á—à–∏–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏.
    - –í –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –≤—ã–±–µ—Ä–∏—Ç–µ **Register Model**.
    - –ó–∞–¥–∞–π—Ç–µ –∏–º—è –º–æ–¥–µ–ª–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:

```
flight_delay_model
```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∫–ª–∞–¥–∫—É **Models** ‚Üí –ø–æ—è–≤–∏—Ç—Å—è –Ω–æ–≤–∞—è –º–æ–¥–µ–ª—å —Å –≤–µ—Ä—Å–∏–µ–π `Version 1`, stage `None`.

***

## üß± –®–∞–≥ 5 ‚Äî –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ CLI / Python

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±:

1. –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ–π `run_id` (–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Run –≤ MLflow UI).
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –∫–æ–º–∞–Ω–¥:

### –ß–µ—Ä–µ–∑ CLI

```bash
mlflow models prepare-container -m "runs:/<run_id>/model" -n flight_delay_model
```


### –ß–µ—Ä–µ–∑ Python

```bash
python -c "import mlflow; mlflow.register_model('runs:/<run_id>/model', 'flight_delay_model')"
```


***

## ü™ú –®–∞–≥ 6 ‚Äî –ü—Ä–∏—Å–≤–æ–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏ (Stage)

–í–æ –≤–∫–ª–∞–¥–∫–µ **Models** –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É –º–æ–¥–µ–ª—å:

- `None` ‚Üí `Staging`: –º–æ–¥–µ–ª—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞, –Ω–æ –Ω–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- `Staging` ‚Üí `Production`: –º–æ–¥–µ–ª—å –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- `Production` ‚Üí `Archived`: —É—Å—Ç–∞—Ä–µ–≤—à–∞—è –º–æ–¥–µ–ª—å

**–î–æ–±–∞–≤—å—Ç–µ –≤ –æ–ø–∏—Å–∞–Ω–∏–µ:**
–≤–µ—Ä—Å–∏–∏ –¥–∞–Ω–Ω—ã—Ö, –∞–≤—Ç–æ—Ä–∞, –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –º–µ—Ç—Ä–∏–∫–∏ ROC AUC/F1.

***

## üß† –®–∞–≥ 7 ‚Äî –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –∏–∑ Registry

–ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞:

```python
import mlflow.pyfunc

model = mlflow.pyfunc.load_model("models:/flight_delay_model/1")
example = [[0.1, 0.2, 0.3, 0.4, 0.5]]  # –æ–±—Ä–∞–∑–µ—Ü –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
print(model.predict(example))
```


***

## üß± –®–∞–≥ 8 ‚Äî (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–∫—Ä–∏–ø—Ç promote_model.py

–°–æ–∑–¥–∞–π—Ç–µ `src/promote_model.py` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è:

```python
import mlflow

MODEL_NAME = "flight_delay_model"
roc_auc_threshold = 0.80

client = mlflow.tracking.MlflowClient()
latest = client.get_latest_versions(MODEL_NAME, stages=["None"])[0]
run = client.get_run(latest.run_id)
roc_auc = run.data.metrics.get("roc_auc", 0)

if roc_auc >= roc_auc_threshold:
    client.transition_model_version_stage(
        name=MODEL_NAME,
        version=latest.version,
        stage="Staging"
    )
    print(f"Model {MODEL_NAME} v{latest.version} promoted to Staging.")
else:
    print(f"Model {MODEL_NAME} v{latest.version} not promoted (ROC_AUC={roc_auc:.2f})")
```

–ó–∞–ø—É—Å–∫:

```bash
python src/promote_model.py
```


***

## üìò –®–∞–≥ 9 ‚Äî –ò—Ç–æ–≥: –æ—Ç—á–µ—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤

1. –ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç: `reports/eval.json` + `reports/eval.html`
2. –ú–æ–¥–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ Model Registry (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ UI)
3. –°–∫—Ä–∏–Ω—à–æ—Ç –≤–∫–ª–∞–¥–∫–∏ **Models**
4. –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è `README` –ø—Ä–æ–µ–∫—Ç–∞:
¬´–í–µ—Ä—Å–∏—è, –¥–∞—Ç–∞, –º–µ—Ç—Ä–∏–∫–∏, Stage = Production¬ª

***

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ |
| :-- | :-- |
| **–ú–µ—Ç—Ä–∏–∫–∏** | –†–∞—Å—á–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ROC AUC, F1, Precision, Recall |
| **–û—Ç—á–µ—Ç** | –§–∞–π–ª `reports/eval.json` –∏–ª–∏ `eval.html` |
| **MLflow Tracking** | Run —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ UI |
| **Model Registry** | –ú–æ–¥–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥ –∏–º–µ–Ω–µ–º `flight_delay_model` |
| **Stage** | –ü—Ä–∏—Å–≤–æ–µ–Ω —Å—Ç–∞—Ç—É—Å Staging/Production |
| **–û—Ç—á–µ—Ç —á–∏—Ç–∞–µ–º** | –í –Ω–µ–º –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ –∏ –≤—ã–≤–æ–¥—ã –æ –∫–∞—á–µ—Å—Ç–≤–µ –º–æ–¥–µ–ª–∏ |


***

## üí° –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ –æ—Ç—á–µ—Ç–∞

```
Model evaluation report
========================
Accuracy: 0.8563
Precision: 0.8731
Recall: 0.8312
F1-Score: 0.8516
ROC-AUC: 0.9124

Confusion Matrix: —Å–º. reports/confusion_matrix.png

–í—ã–≤–æ–¥: –º–æ–¥–µ–ª—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏; —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è stage Staging.
```


***

## üì¶ –ò—Ç–æ–≥–æ–≤—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:

- `reports/eval.json`
- `reports/eval.html`
- `reports/confusion_matrix.png`
- Registered model: `flight_delay_model`
- –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ —Å–æ Stage –≤ MLflow UI

***

## üìö –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é

1. **–î–æ–±–∞–≤–∏—Ç—å baseline‚Äë–º–æ–¥–µ–ª—å** ‚Üí —Å—Ä–∞–≤–Ω–∏—Ç—å ROC AUC —Å –Ω–æ–≤–æ–π.
2. **–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retrain** ‚Üí –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫.
3. **–í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å CI/CD**: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ GitHub Actions.
4. **–°–æ–∑–¥–∞—Ç—å DVC stage evaluate** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ü–µ–Ω–∫–∏.

***

### üí¨ –í—ã–≤–æ–¥

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç:

- –ü–æ–Ω–∏–º–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ—Ü–µ–Ω–∫–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π.
- –£–º–µ–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å MLflow Tracking –∏ Model Registry.
- –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é CI/CD –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø—Ä–æ—Ü–µ—Å—Å–∞–º MLOps –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω‚Äë—Å—Ü–µ–Ω–∞—Ä–∏—è—Ö.

